# カトル（Cuttle）機能設計書

## 1. ゲーム基本情報

### 1.1 プレイヤー
- 2人対戦（player1 vs player2/CPU）
- player1 = 先攻（手札5枚でスタート）
- player2 = 後攻（手札6枚でスタート）

### 1.2 デッキ構成
- 52枚（4種族 × 13ランク）
- 種族: Human, Elf, Goblin, Demon
- ランク: A, 2, 3, 4, 5, 6, 7, 8, 9, 10, J, Q, K

### 1.3 勝利条件
- 自分の場の点数合計 >= 勝利必要点数
- 基本は21点、Kの枚数で変動：
  - K0枚: 21pt
  - K1枚: 14pt
  - K2枚: 10pt
  - K3枚: 7pt
  - K4枚: 5pt

### 1.4 引き分け条件
- 山札が0枚の状態で3回連続パス

---

## 2. ターンアクション（1ターンに1つだけ）

### 2.1 ドロー
- 山札から1枚引いて手札に加える
- 山札0枚時は不可

### 2.2 パス
- 山札が0枚の時のみ可能
- 何もせずターン終了

### 2.3 カードをプレイ
以下のいずれか：
1. **点数カードとして配置** - 自分の場に置いて点数を得る
2. **ワンオフ効果として使用** - 効果発動後、捨て札へ
3. **永続効果として配置** - 場に残り続け効果を発揮
4. **スカトル** - 相手の点数カードを破壊

---

## 3. カード別機能詳細

### 3.1 数札（A〜10）

| ランク | 点数 | ワンオフ効果 | ターゲット | Q保護 |
|--------|------|--------------|------------|-------|
| A | 1pt | 相手の**点数カード**1枚を破壊 | 相手の点数カード | ✓ |
| 2 | 2pt | 相手の**永続効果**1枚を破壊 | 相手の永続効果(J,Q,K,8) | - |
| 3 | 3pt | 捨て札から1枚を手札に回収 | 捨て札のカード | - |
| 4 | 4pt | 相手に手札2枚を捨てさせる | なし（自動） | - |
| 5 | 5pt | 山札から2枚ドロー | なし（自動） | - |
| 6 | 6pt | **全員**の永続効果を全破壊 | なし（自動） | - |
| 7 | 7pt | 山札トップを見てプレイ or 手札からプレイ | 特殊フェーズ | - |
| 8 | 8pt | 永続：相手手札を公開（メガネ） | なし | - |
| 9 | 9pt | 相手の**任意のカード**1枚を手札に戻す | 点数or永続 | 点数のみ✓ |
| 10 | 10pt | 相手の**点数カード**1枚を手札に戻す | 相手の点数カード | ✓ |

### 3.2 絵札（J, Q, K）

| ランク | 効果タイプ | 効果内容 | ターゲット | Q保護 |
|--------|------------|----------|------------|-------|
| J | 永続 | 相手の点数カードを略奪（自分の点数になる） | 相手の点数カード | ✓ |
| Q | 永続 | 自分の点数カードを効果から保護 | なし | - |
| K | 永続 | 勝利必要点数を-7 | なし | - |

---

## 4. 特殊ルール詳細

### 4.1 Q（魔術師）の保護効果
Qが場にある間、自分の**点数カード**は以下から保護：
- Aの効果（破壊）
- 9の効果（手札戻し）※点数カードのみ
- 10の効果（手札戻し）
- Jの効果（略奪）
- スカトル

**注意**: Qは永続効果なので2の効果で破壊可能

### 4.2 J（騎士）の略奪
- 相手の点数カードに重ねて配置
- そのカードの点数が自分のものになる
- 複数のJを重ねられる（一番上のJの所有者のもの）
- Jが破壊されると点数カードは元の持ち主に戻る
- 6の効果でJだけ破壊され、点数カードは残る

### 4.3 8（メガネ）の特殊性
- **点数としても永続としても出せる唯一のカード**
- 点数として出す → 8点
- 永続として出す → 相手手札公開、0点

### 4.4 スカトル
条件：自分の数札の数字 >= 相手の点数カードの数字

**同数字の場合は種族相性で判定**:
```
強さ: エルフ(最弱) < ゴブリン < 人間 < デーモン(最強)
例外: エルフはデーモンにのみ勝てる
```

| 結果 | 処理 |
|------|------|
| 勝利（攻撃側有利）| 相手カードのみ捨て札 |
| 敗北（攻撃側不利）| 自分カードのみ捨て札 |
| 相打ち（同種族）| 両方捨て札 |

---

## 5. 点数計算

### 5.1 基本ルール
```
プレイヤーの点数 = 自分がcontrollerである全カードのvalueの合計
```

### 5.2 controller
- 通常: owner = controller（配置した人）
- J略奪後: controllerがJを出した人に変わる
- J破壊後: controllerが元のownerに戻る

### 5.3 注意点
- 永続として出した8は value=0
- J, Q, Kは常に value=0
- Jで略奪したカードは**相手のfield配列に残ったまま**controllerだけ変わる

---

## 6. UI操作フロー

### 6.1 手札からのドラッグ
1. カードをタップ → 閲覧モード
2. 上にスワイプ → ドラッグモード
3. ドロップ先に応じて処理

### 6.2 ドロップターゲット

| ドロップ先 | 対象カード | アクション |
|------------|------------|------------|
| 自分の点数エリア | A-10 | 点数として配置 |
| 自分の効果エリア | 8,Q,K | 永続として配置 |
| 自分の効果エリア | 3-7,9,10 | ワンオフ効果（ターゲット不要） |
| 相手の点数カード | A,9,10,J,数札 | モーダルで選択 |
| 相手の永続効果 | 2,9 | モーダルで選択 |

### 6.3 アクション確認モーダル
相手カードにドロップ時に表示：
- **効果発動ボタン** - A,2,9,10,J使用時
- **スカトルボタン** - 数札で相手点数カードを破壊
- **戻るボタン** - キャンセル

---

## 7. ゲームフェーズ

| フェーズ | 説明 |
|----------|------|
| selectAction | 通常ターン（アクション選択待ち）|
| selectTarget | ターゲット選択待ち（A,2,9,10,J使用時）|
| opponentDiscard | 4の効果で相手が手札を捨てる |
| sevenChoice | 7の効果で山札トップを見てプレイ |
| gameOver | ゲーム終了 |

---

## 8. 現状の実装状況チェックリスト

### 8.1 基本アクション
- [x] ドロー
- [x] パス（山札0時のみ）
- [x] 点数カード配置
- [ ] **8を点数として出す選択肢** - UIで永続のみ

### 8.2 ワンオフ効果
- [x] A: 相手点数カード破壊
- [x] 2: 相手永続効果破壊
- [ ] **3: 捨て札から回収** - ロジックあり、**UIなし**
- [x] 4: 相手手札2枚捨て（CPU自動）
- [x] 5: 2枚ドロー
- [x] 6: 全永続破壊
- [ ] **7: 山札トップを見てプレイ** - ロジックあり、**UIなし**
- [x] 9: 相手カード手札戻し
- [x] 10: 相手点数カード手札戻し

### 8.3 永続効果
- [ ] **J: 略奪** - ロジックあり、**オーバーレイ表示なし**
- [x] Q: 点数カード保護
- [x] K: 勝利点数減少

### 8.4 スカトル
- [x] 基本スカトル
- [x] 同数字の種族相性
- [x] Q保護チェック

### 8.5 バグ一覧
1. **略奪カードの表示**
   - 現状: `fc.owner !== 'player1'` で判定
   - 正解: `fc.controller !== fc.owner` で判定すべき
   - Jオーバーレイ表示もない

2. **3の効果UI未実装**
   - 捨て札選択モーダルがない
   - 効果エリアにドロップしても発動しない

3. **7の効果UI未実装**
   - sevenChoiceフェーズのUIがない
   - 山札トップの表示・選択UIがない

4. **8の二重性未対応**
   - 点数(8pt)か永続(0pt+効果)か選べるべき
   - 現状は永続のみ

5. **敵効果エリアへのターゲット指定**
   - Aは点数カードのみ、2は永続のみターゲット可
   - 現状の判定が曖昧な可能性

---

## 9. 修正優先度

### Priority 1（ゲーム進行に必須）
1. 7の効果UI
2. 3の効果UI
3. J略奪のオーバーレイ表示

### Priority 2（正確性）
1. stolen判定修正（controller使用）
2. 8の点数/永続選択
3. A/2のターゲット制限

### Priority 3（UX改善）
1. 各効果のエフェクト追加
2. ログの詳細化

---

## 9. データ構造

### 9.1 Card
```typescript
interface Card {
  id: string;           // "Human-10"
  rank: Rank;           // 'A' | '2' | ... | 'K'
  race: Race;           // 'Human' | 'Elf' | 'Goblin' | 'Demon'
  value: number;        // 点数 (J,Q,K=0, 8永続時=0)
}
```

### 9.2 FieldCard
```typescript
interface FieldCard {
  card: Card;
  owner: PlayerId;           // 元の所有者
  controller: PlayerId;      // 現在の支配者（Jで変わる）
  attachedKnights: Card[];   // 付いているJのリスト
}
```

### 9.3 Player
```typescript
interface Player {
  id: PlayerId;
  name: string;
  hand: Card[];
  field: FieldCard[];
  kings: number;        // 場に出ているKの枚数
}
```

