================================================================================
                        カトル（Cuttle）ゲーム 仕様書
================================================================================
最終更新: 2026年1月9日
GitHub Pages: https://159265moneys.github.io/cuttle-game/

================================================================================
【1. ゲーム概要】
================================================================================

カトルは2人対戦のカードゲームです。
52枚のデッキを使用し、ポイントを集めて勝利条件を満たすことを目指します。

■ 勝利条件
- 基本: 21ポイント以上を場に出す
- Kの枚数に応じて必要ポイントが変動:
  - K 0枚: 21pt
  - K 1枚: 14pt
  - K 2枚: 10pt
  - K 3枚: 7pt
  - K 4枚: 5pt

■ マッチ形式
- 3本勝負（先に2勝した方が勝利）
- 各ラウンドで先攻/後攻が交代

================================================================================
【2. カードの種族（スート）】
================================================================================

4種類の種族があり、トランプのスートに相当:
- エルフ (Elf) - 黄色系
- ゴブリン (Goblin) - 緑系
- ニンゲン (Human) - 赤系
- デーモン (Demon) - 青系

各種族にA, 2-10, J, Q, K の13枚、合計52枚。

================================================================================
【3. カードの効果】
================================================================================

■ 数字カード (A, 2-10)
点数としてプレイ: カードの数字がそのままポイントになる
ワンオフ効果: 1回限りの効果を発動して墓地へ

【A (エース)】
- 点数: 1pt
- ワンオフ: 相手の点数カードを1枚破壊（Qで保護されていない場合）

【2】
- 点数: 2pt
- ワンオフ: 相手の永続効果カード(8,J,Q,K)を1枚破壊

【3】
- 点数: 3pt
- ワンオフ: 墓地からカードを1枚手札に回収

【4】
- 点数: 4pt
- ワンオフ: 相手は手札から2枚選んで捨てる

【5】
- 点数: 5pt
- ワンオフ: 山札から2枚ドロー

【6】
- 点数: 6pt
- ワンオフ: 場の全ての永続効果カード(8,J,Q,K)を破壊（両プレイヤー）

【7】
- 点数: 7pt
- ワンオフ: 山札の上から2枚を見て、1枚を選んで即プレイ
  - オプションA: 見たカードから1枚選んで即座にプレイ
  - オプションB: 見たカードを山札の下に戻し、手札からプレイ

【8】
- 点数: 8pt
- 永続効果: 相手の手札を公開状態にする（常に見える）

【9】
- 点数: 9pt
- ワンオフ: 相手のカード（点数または永続効果）を1枚手札に戻す

【10】
- 点数: 10pt
- ワンオフ: 相手の点数カードを1枚手札に戻す（Qで保護されていない場合）

■ 絵札 (J, Q, K)

【J (ジャック)】
- 永続効果: 相手の点数カードを1枚略奪（自分のポイントとしてカウント）
- Qで保護されている相手のカードは略奪不可
- 自分のカードが敵のJで略奪されている場合、自分のJで取り返せる

【Q (クイーン)】
- 永続効果: 自分の点数カードをA, 9, 10, Jの効果から保護
- 保護対象は自分がownerかつcontrollerのカードのみ

【K (キング)】
- 永続効果: 勝利に必要なポイントを減少させる
- K1枚で21→14, 2枚で14→10, 3枚で10→7, 4枚で7→5

================================================================================
【4. ゲームフロー】
================================================================================

■ 起動時
1. コイントス画面
   - 上にスワイプでコインを投げる
   - オモテ: プレイヤー先攻
   - ウラ: プレイヤー後攻

2. ラウンド開始画面
   - 「ROUND X START」表示
   - 上下にプレイヤー/敵のアイコン、名前、マッチインジケーター表示

3. カード配り演出
   - 山札から交互にカードを配る（後攻から先に配る）
   - 先攻: 5枚、後攻: 6枚
   - 150msごとに1枚ずつ配られる
   - 配り終わるまでプレイ不可

■ ターン中のアクション
- ドロー: 山札から1枚引く
- カードをプレイ:
  - 点数として場に出す
  - 効果を発動する
- アタック（スカトル）: 自分の点数カードで相手の点数カード（同値以下）を破壊
- パス: 何もせずターン終了

■ 操作方法
- 手札のカードをタップ: 閲覧モード（カード詳細と効果説明を表示）
- 上にスワイプ: ドラッグモード
- ドラッグ&ドロップ:
  - 自分の点数エリア: 点数としてプレイ
  - 自分の効果エリア: 効果としてプレイ
  - 敵の点数カード: アタックまたは効果発動（選択モーダル表示）
  - 敵の効果カード: 2カードで破壊

■ マッチ終了時
- 2秒間結果表示後、自動で次のラウンド開始画面へ
- 2勝で最終結果画面（「勝利！」または「敗北...」）

================================================================================
【5. UI/UXデザイン】
================================================================================

■ カードデザイン
- 羊皮紙風テクスチャ背景
- 種族ごとの色分け
- 絵札(A,J,Q,K): 専用イラスト（マスク画像使用）
- 数字カード: トランプ準拠のスート配置（ピップ）

■ 手札表示
- 扇状に配置
- 枚数に応じて自動調整（重なり具合）
- 敵の手札は裏面表示（8の効果で公開時は簡易表示）

■ フィールド表示
- 敵エリア（上部）:
  - 効果エリア: 12.5%
  - 点数エリア: 14.5%
- 自分エリア（下部）:
  - 点数エリア
  - 効果エリア

■ HPリング（アイコン周囲）
- プレイヤー: 青色 (#5ed3f3)
- 敵: 赤色 (#f35e5e)
- Kの効果: 金色でセグメント表示
- 段階的にアニメーションで増減（transition: 0.5s）

■ マッチインジケーター（○○○）
- 3つの丸で勝敗を表示
- 自分勝ち時: 自分=明るい青(#5ed3f3)、敵=暗い赤(#6a2a2a)
- 自分負け時: 自分=暗い青(#2a4a6a)、敵=明るい赤(#f35e5e)
- 未決定: 暗い灰色

================================================================================
【6. アニメーション・演出】
================================================================================

■ カード配り演出
- 山札からプレイヤー/敵の手札エリアへカードが飛ぶ
- 後攻（6枚）から先に配る
- 交互に1枚ずつ、150ms間隔
- 配られたカードは順次手札に表示

■ ドロー演出
- 山札から手札エリアへカードが飛ぶアニメーション
- プレイヤー/CPU両方に適用

■ ポイント獲得演出
- 点数カードをプレイした位置からプレイヤーアイコンへ光の粒子が飛ぶ
- 粒子の数 = カードの数字（1なら1個、10なら10個）
- 開始位置・終了位置にランダムなばらつき
- 各粒子にランダムな遅延（0〜0.3秒）

■ 攻撃/破壊演出
- フラッシュエフェクト（150ms）
- 画面振動（200ms）
- ガラス破砕エフェクト（対象位置で破片が飛び散る）
- 適用タイミング:
  - プレイヤーのアタック
  - プレイヤーのA/2効果
  - CPUの攻撃/効果（プレイヤーカード破壊時）
  - 6の効果（全永続破壊）

■ Q保護オーバーレイ
- Qで保護されている点数カードに発光エフェクト
- プレイヤー側: 青い光 (#5ed3f3)
- 敵側: 赤い光 (#f35e5e)
- パルスアニメーション（2秒周期）

■ ドラッグターゲットハイライト
- ドラッグ中に対象カードの枠が青く発光
- 浮き上がりなし（位置は変わらない）

■ オーバーレイ画面
- コイントス、ラウンド開始: 背景にゲーム盤面が透けて見える
- 背景色: rgba(0,0,0,0.85)

================================================================================
【7. ログシステム】
================================================================================

■ 表示位置
- 中央（山札と墓地の間）

■ ログ内容
- ラウンド開始: 「ROUND X START」
- CPUドロー: 「ドローした」
- カードプレイ: 「[種族][ランク]を場にセット」
- 効果発動: 「[種族][ランク]の永続効果を発動」
- 破壊: 「[種族][ランク]を破壊した」
- 手札に戻す: 「[種族][ランク]を手札に戻した」
- 略奪: 「Jで[種族][ランク]を略奪」
- 勝利: 「勝利！」

■ リセットタイミング
- 新しいラウンド開始時（turnCount === 1）
- 変化検出のprev refsもリセット（誤検知防止）

================================================================================
【8. CPU AI】
================================================================================

■ 基本ロジック
- 勝てる状況なら積極的にポイントを出す
- Qがあれば優先的にプレイ（カード保護）
- 相手のポイントが高い場合は破壊/手札戻しを優先
- 手札が少ない場合はドローを選択
- 有効なアクションがない場合はパス

■ 4の効果（手札捨て）
- CPUは価値の低いカードから捨てる
- 永続効果カード > 低い点数カード の優先順位

================================================================================
【9. 技術仕様】
================================================================================

■ フレームワーク/ライブラリ
- React 18 + TypeScript
- Vite (ビルドツール)
- Tailwind CSS
- gh-pages (デプロイ)

■ 主要コンポーネント
- App.tsx: メイン制御、ゲームフロー管理
- CuttleBattle.tsx: バトル画面UI
- CoinFlip.tsx: コイントス画面
- RoundStart.tsx: ラウンド開始画面

■ 状態管理
- GameState: ゲーム全体の状態
- MatchState: マッチ（3本勝負）の状態
- 各種useStateでUI状態管理

■ スプライト
- /sprite/suit/: 種族アイコン
- /sprite/ajqk/: 絵札イラスト
- /sprite/back/: カード裏面

■ z-index階層
- ゲーム盤面: 1〜10000
- オーバーレイ（CoinFlip, RoundStart, FinalResult）: 100000

================================================================================
【10. 既知の仕様/制限】
================================================================================

- スマートフォン縦画面専用（横画面非対応）
- シングルプレイヤーのみ（オンライン対戦なし）
- CPUの強さ調整機能なし
- カードアニメーションは簡易版（3Dフリップなし）

================================================================================
【11. 更新履歴】
================================================================================

2026/01/09:
- 初期実装完了
- コイントス/ラウンド開始のオーバーレイ実装
- カード配り演出（交互、後攻優先）
- CPUの行動待機（配り完了まで）
- マッチインジケーター色統一
- ログシステム（ROUND X START表示、誤検知防止）
- ドロー演出追加
- CPU攻撃演出追加
- 6の効果演出追加
- Q保護オーバーレイ強化

================================================================================

